{% extends "base.html" %}

{% load static wagtailcore_tags %}

{% block body_class %}template-rtei{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" type="text/css" href="{% static 'vendor/c3/c3.css' %}">
{% endblock %}

{% block content %}
  <div class="main">

    <section id="chart-controls" class="controls">
      <button type="button" id="chart-sort-by-name" class="sort asc" data-key="name">Sort by Name</button><button type="button" id="chart-sort-by-score" class="sort asc" data-key="index">Sort by Total Score</button>
    </section>
    <section>
      <div class="text">
        {{ self.body|richtext }}
      </div>
      <div id="chart"></div>
    </section>

  </div>

{% endblock %}

{% block extra_js %}
    <script src="{% static 'vendor/underscore-min.js' %}" type="text/javascript" charset="utf-8"></script>
    <script src="{% static 'vendor/d3/d3.min.js' %}" type="text/javascript" charset="utf-8"></script>
    <script src="{% static 'vendor/c3/c3.min.js' %}" type="text/javascript" ></script>
    <script type="text/javascript">
        var chart;
        var json_data;
        var build_chart = function(data) {
            // Chart height is the number of rows * 22, or 350, whichever is
            // largest. This ensures there is adequate room for double-lined
            // labels.
            var height = _.max([_.size(data) * 22, 350]);
            var chart = c3.generate({
                bindto: '#chart',
                data: {
                    json: data,
                    order: null,
                    keys: {
                        x: 'name',
                        value: ['1', '3', '2', '5', '4'],
                    },
                    groups: [
                        ['1', '2', '3', '4', '5'],
                    ],
                    names: {
                        '1': 'Governance',
                        '3': 'Accessibility',
                        '2': 'Availability',
                        '5': 'Adaptability',
                        '4': 'Acceptability'
                    },
                    type: 'bar'
                },
                axis: {
                    rotated: true,
                    x: {
                        type: 'category'
                    },
                    y: {
                        show: true,
                        max: 100,
                        padding: {
                            top: 0,
                        }
                    }
                },
                bar: {
                    width: {
                        ratio: 0.75
                    }
                },
                size: {
                    height: height
                },
                tooltip: {
                  format: {
                    value: function (value, ratio, id, index) {
                        return parseFloat((value * 5).toFixed(2));
                    }
                  }
                }
            });
            return chart;
        };

        var init_sort_buttons = function() {
            /*
            Initializes the sort buttons.

            The button has either an `asc` or `desc` class that defines its
            current state, which can be used for styling purposes.
            */

            $('#chart-controls :button.sort').each(function(i, el) {
                $(el).on('click', function(ev) {
                    var btn = $(ev.target);
                    var desc = btn.hasClass('asc');
                    $('#chart-controls :button.active').removeClass('active');
                    btn.addClass('active');
                    if (desc) {
                        btn.addClass('desc').removeClass('asc');
                    } else {
                        btn.addClass('asc').removeClass('desc');
                    }
                    sortByKey(btn.data('key'), desc);
                });
            });
        };

        var sortByKey = function(key, desc) {
            // Sort json_data by key and rebuild chart.
            json_data = _.sortBy(json_data, key);
            if (desc) json_data.reverse();
            chart = build_chart(json_data);
        };

        // Get the data and initialize the chart.
        // TODO: remove once we have the final data
        {% if request.GET.random %}
            var json_data = $.getJSON("{% static 'data/c3_scores_per_country_random.json' %}", function(data) {
        {% else %}
            var json_data = $.getJSON("{% static 'data/c3_scores_per_country.json' %}", function(data) {
        {% endif %}
            json_data = data;
            init_sort_buttons();
            chart = build_chart(json_data);
        });
    </script>
{% endblock %}
